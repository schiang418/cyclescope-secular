name: Weekly Secular Analysis

on:
  schedule:
    # Run every Friday at 4:30 PM ET (20:30 UTC in winter, 21:30 UTC in summer)
    # Using 20:30 UTC for EST (winter time)
    - cron: '30 20 * * 5'
  workflow_dispatch: # Allow manual trigger

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Stock Chart
        run: |
          echo "üìä Triggering chart download..."
          RESPONSE=$(curl -X POST \
            https://cyclescope-secular-production.up.railway.app/download \
            -H "Content-Type: application/json" \
            -s)
          
          echo "Download response: $RESPONSE"
          
          # Check if download started successfully
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Download started successfully"
          else
            echo "‚ùå Download failed"
            exit 1
          fi
      
      - name: Wait for Download to Complete
        run: |
          echo "‚è≥ Waiting 30 seconds for download to complete..."
          sleep 30
          
          # Check download status
          STATUS=$(curl -s https://cyclescope-secular-production.up.railway.app/download-status)
          echo "Download status: $STATUS"
          
          if echo "$STATUS" | grep -q '"lastSuccess":true'; then
            echo "‚úÖ Download completed successfully"
          else
            echo "‚ùå Download did not complete successfully"
            exit 1
          fi
      
      - name: Run Secular Analysis
        run: |
          echo "üîç Triggering secular analysis..."
          RESPONSE=$(curl -X POST \
            https://cyclescope-secular-production.up.railway.app/analyze \
            -H "Content-Type: application/json" \
            -s \
            --max-time 180)
          
          echo "Analysis response: $RESPONSE"
          
          # Check if analysis completed successfully
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "‚úÖ Analysis completed successfully"
          else
            echo "‚ùå Analysis failed"
            exit 1
          fi
      
      - name: Verify Analysis Results
        run: |
          echo "‚úÖ Verifying analysis results..."
          
          # Check if annotated chart is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            https://cyclescope-secular-production.up.railway.app/annotated-chart)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Annotated chart is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è  Annotated chart returned HTTP $HTTP_CODE"
          fi
          
          # Get latest analysis
          LATEST=$(curl -s https://cyclescope-secular-production.up.railway.app/analysis/latest)
          echo "Latest analysis: $LATEST"
          
          if echo "$LATEST" | grep -q '"success":true'; then
            echo "‚úÖ Latest analysis is available"
          else
            echo "‚ùå Latest analysis is not available"
            exit 1
          fi
      
      - name: Send Notification (Optional)
        if: success()
        run: |
          echo "üéâ Weekly secular analysis completed successfully!"
          echo "üìÖ Date: $(date)"
          echo "üåê View results at: https://cyclescope-portal-production.up.railway.app/"
